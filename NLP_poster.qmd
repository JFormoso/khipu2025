---
title: "Consideraciones sobre la Ciencia Abierta de investigadores e investigadoras del sur global : un análisis desde herramientas de NLP"
author: "Formoso, J., Nanton, M. C., Loto, P. A."
format: html
editor: visual
execute: 
  echo: true
embed-resources: true
---

```{r}
# Paquetes
library(tidyverse)
library(tidytext)
library(googlesheets4)
library(topicmodels)
library(tm)

# Datos
datos <- read_sheet("1ZaaZFXhc9KfQgpWehNpl6Qyam-49O2nHS786fKrXFCw", sheet = "info_inscriptos")
```

## Procesamientos base

Selección de preguntas abiertas

```{r}
texto_libre <- datos %>%  
  select(interes_ES,
         barreras_ES,
         publico_general_ES)
```

### Tokenización

```{r}
tok_interes <- texto_libre %>%
  select(interes_ES) %>% 
  unnest_tokens(word, interes_ES) %>% 
  filter(!word %in% stopwords("es")) %>% 
  mutate(document = "interes_ES")
```

```{r}
tok_barreras <- texto_libre %>%
  select(barreras_ES) %>% 
  unnest_tokens(word, barreras_ES) %>% 
  filter(!word %in% stopwords("es")) %>% 
  mutate(document = "barreras_ES")
```

```{r}
tok_public <- texto_libre %>%
  select(publico_general_ES) %>% 
  unnest_tokens(word, publico_general_ES)  %>% 
  filter(!word %in% stopwords("es")) %>% 
  mutate(document = "publico_general_ES")
```

```{r}
tok_all <- texto_libre %>% 
  pivot_longer(cols = interes_ES:publico_general_ES,
               values_to = "text") %>% 
  rename(document = name) %>% 
  unnest_tokens(word, text) %>% 
  filter(!word %in% stopwords("es"))
```

### Conteo de frecuencias

```{r}
tok_c_interes <- tok_interes %>% count(document, word)

tok_c_barreras <- tok_barreras %>% count(document, word)

tok_c_public <- tok_public %>% count(document, word)

tok_c_all <- tok_all %>% count(document, word)
```

### DTM

```{r}
dtm_interes <- tok_c_interes %>% 
  cast_dtm(document, word, n)

dtm_barreras <- tok_c_barreras %>% 
  cast_dtm(document, word, n)

dtm_public <- tok_c_public %>% 
  cast_dtm(document, word, n)

dtm_all <- tok_c_all %>% 
  cast_dtm(document, word, n)
```

## Análisis de frecuencias

```{r}

tok_c_all_sw <- tok_c_all |>
  filter(!word %in% stopwords("es")) |>
  arrange(desc(n))

total_words <- tok_c_all_sw %>% 
  group_by(document) %>% 
  summarize(total = sum(n))

tok_c_all_sw <- left_join(tok_c_all_sw, total_words)

tok_c_all_sw
```

```{r}
tok_c_all_sw |>
  ggplot(aes(n/total, fill = document)) +
  geom_histogram(show.legend = FALSE) +
  xlim(NA, 0.0009) +
  facet_wrap(~document, ncol = 2, scales = "free_y")
```

```{r}

freq_by_rank <- tok_c_all_sw %>% 
  group_by(document) %>% 
  mutate(rank = row_number(), 
         term_frequency = n/total) %>%
  ungroup()

freq_by_rank
```

```{r}
freq_by_rank %>% 
  ggplot(aes(rank, term_frequency, color = document)) + 
  geom_line(linewidth = 1.1, alpha = 0.8, show.legend = FALSE) + 
  scale_x_log10() +
  scale_y_log10()
```

```{r}
rank_subset <- freq_by_rank %>% 
  filter(rank < 500,
         rank > 10)

lm(log10(term_frequency) ~ log10(rank), data = rank_subset)
```

```{r}
freq_by_rank %>% 
  ggplot(aes(rank, term_frequency, color = document)) + 
  geom_abline(intercept = -0.62, slope = -1.1, 
              color = "gray50", linetype = 2) +
  geom_line(linewidth = 1.1, alpha = 0.8, show.legend = FALSE) + 
  scale_x_log10() +
  scale_y_log10()
```

```{r}
tf_idf <- tok_c_all_sw %>%
  bind_tf_idf(word, document, n)

tf_idf |>
  select(-total) |>
  arrange(desc(tf_idf))
```

```{r}
tf_idf %>%
  group_by(document) %>%
  slice_max(tf_idf, n = 15) %>%
  ungroup() %>%
  ggplot(aes(tf_idf, fct_reorder(word, tf_idf), fill = document)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~document, ncol = 2, scales = "free") +
  labs(x = "tf-idf", y = NULL)
```

## Análisis de sentimiento

## Modelado de tópicos

### LDA

Requiere formato tidy: a table with one-token-per-document-per-row, such as is constructed by the [`unnest_tokens()`](https://juliasilge.github.io/tidytext/reference/unnest_tokens.html) function

#### All

```{r}
lda_all <- LDA(dtm_all, k = 2, control = list(seed = 1234))
topics_all <- tidy(lda_all)
```

```{r}
all_top_terms <- topics_all %>%
  group_by(topic) %>%
  slice_max(beta, n = 10) %>% 
  ungroup() %>%
  arrange(topic, -beta)

all_top_terms %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(beta, term, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  scale_y_reordered()
```
```{r}
beta_wide_all <- topics_all %>%
  mutate(topic = paste0("topic", topic)) %>%
  pivot_wider(names_from = topic, values_from = beta) %>% 
  filter(topic1 > .001 | topic2 > .001) %>%
  mutate(log_ratio = log2(topic2 / topic1))
beta_wide_all
```

#### Barreras

```{r}
lda_barreras <- LDA(dtm_barreras, k = 2, control = list(seed = 1234))
topics_barreras <- tidy(lda_barreras)
```

```{r}
barreras_top_terms <- topics_barreras %>%
  group_by(topic) %>%
  slice_max(beta, n = 10) %>% 
  ungroup() %>%
  arrange(topic, -beta)

barreras_top_terms %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(beta, term, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  scale_y_reordered()
```

```{r}
beta_wide_barreras <- topics_barreras %>%
  mutate(topic = paste0("topic", topic)) %>%
  pivot_wider(names_from = topic, values_from = beta) %>% 
  filter(topic1 > .001 | topic2 > .001) %>%
  mutate(log_ratio = log2(topic2 / topic1))
beta_wide_barreras
```

#### Interes

```{r}
lda_interes <- LDA(dtm_interes, k = 2, control = list(seed = 1234))
topics_interes <- tidy(lda_interes)
```

```{r}
interes_top_terms <- topics_interes %>%
  group_by(topic) %>%
  slice_max(beta, n = 10) %>% 
  ungroup() %>%
  arrange(topic, -beta)

interes_top_terms %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(beta, term, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  scale_y_reordered()
```

```{r}
beta_wide_interes <- topics_interes %>%
  mutate(topic = paste0("topic", topic)) %>%
  pivot_wider(names_from = topic, values_from = beta) %>% 
  filter(topic1 > .001 | topic2 > .001) %>%
  mutate(log_ratio = log2(topic2 / topic1))
beta_wide_interes
```

#### Public

```{r}
lda_public <- LDA(dtm_public, k = 2, control = list(seed = 1234))
topics_public <- tidy(lda_public)
```

```{r}
public_top_terms <- topics_public %>%
  group_by(topic) %>%
  slice_max(beta, n = 10) %>% 
  ungroup() %>%
  arrange(topic, -beta)

public_top_terms %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(beta, term, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  scale_y_reordered()
```

```{r}
beta_wide_public <- topics_public %>%
  mutate(topic = paste0("topic", topic)) %>%
  pivot_wider(names_from = topic, values_from = beta) %>% 
  filter(topic1 > .001 | topic2 > .001) %>%
  mutate(log_ratio = log2(topic2 / topic1))
beta_wide_public
```